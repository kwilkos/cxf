<project name="Celtix common build file" default="build">
        
    <property environment="env"/>
    <property name="build.dir" location ="${basedir}/build"/>
    <property name="build.classes.dir" location ="${build.dir}/classes"/>
    <property name="build.src.dir" location ="${build.dir}/src"/>
    <property name="build.var.dir" location ="${build.dir}/var"/>
    <property name="codegen.timestamp.file" value="${build.src.dir}/.CODEGEN_DONE"/>
    <property name="wsdl.dir" location="${basedir}/wsdl"/>
    <property name="war.dir" location="${build.dir}/war"/>

    <uptodate property="codegen.notrequired" value="true">
        <srcfiles dir="${wsdl.dir}" includes="*.wsdl"/>
        <srcfiles dir="${wsdl.dir}" includes="*.xsd"/>
        <mapper type="merge" to="${codegen.timestamp.file}"/>
    </uptodate>
        
    <!-- find the tools jar, which on darwin, tools.jar does not exist -->
    <available property="tools.jar" value="$${env.JAVA_HOME}/lib/tools.jar"
       file="${env.JAVA_HOME}/lib/tools.jar"/>
    <path id="jdk.tools.classpath">
        <pathelement location="${tools.jar}"/>
    </path>

    <condition property="is.java.version.15">
        <equals arg1="${ant.java.version}" arg2="1.5"/>
    </condition>

    <fail message="Celtix requires Java version 1.5 or higher. You are currently using Java version ${ant.java.version}."
        unless="is.java.version.15"/>

    <!-- Determine celtix.home, either from the environment variable CELTIX_HOME
       - or using ../..
       -->
    <condition property="celtix.home" value="${env.CELTIX_HOME}">
        <isset property="env.CELTIX_HOME"/>
    </condition>
    <property name="celtix.home" location="../.."/>

    <!-- Determine celtix.jar.file, either ${celtix.home}/build/lib/celtix.jar
       - in a source distribution, or ${celtix.home}/lib/celtix.jar in a binary
       - distribution.
       -->
    <condition property="celtix.jar.lib.dir" value="${celtix.home}/build/lib">
        <available file="celtix.jar" type="file" filepath="${celtix.home}/build/lib"/>
    </condition>
    <property name="celtix.jar.lib.dir" value="${celtix.home}/lib"/>
    <property name="celtix.jar.file" value="${celtix.jar.lib.dir}/celtix.jar"/>

    <fail message="The location ${celtix.home} does not seem to contain a Celtix installation; if you are importing this common build file from a location other than the Celtix samples directory then you need to set the CELTIX_HOME environment variable.">
        <condition>
            <not>
                <isset property="celtix.jar.file" />
            </not>
        </condition>
    </fail>

    <!-- Determine the tools directory, either ${celtix.home}/tools
       - in a source distribution, or ${celtix.home}/lib in a binary
       - distribution.
       -->
    <condition property="thirdparty.tools.dir" value="${celtix.home}/tools">
        <available file="tools" type="dir" filepath="${celtix.home}"/>
    </condition>

    <condition property="thirdparty.tools.dir" value="${celtix.home}/lib">
        <available file="lib" type="dir" filepath="${celtix.home}"/>
    </condition>

    <property name="jaxws.home" value="${thirdparty.tools.dir}/jaxws-ri/20051104/"/>
    <property name="jaxws.lib.dir" location="${jaxws.home}/lib"/>
    <property name="celtix.etc.dir" location="${celtix.home}/etc"/>

    <path id="celtix.classpath">
        <pathelement location="${basedir}/../../build/classes"/>
        <pathelement location="${build.classes.dir}"/>
        <pathelement location="${celtix.jar.file}"/>
    </path>

    <target name="maybe.generate.code" unless="codegen.notrequired">
        <antcall target="generate.code"/>
        <touch file="${codegen.timestamp.file}"/>
    </target>
    <target name="compile" depends="maybe.generate.code">
        <javac srcdir="${basedir}/src" destdir="${build.classes.dir}" debug="true">
            <classpath refid="celtix.classpath" />
        </javac>
        <copy todir="${build.classes.dir}">
            <fileset dir="${basedir}/src" includes="**/*.xml" />
        </copy>
    </target>

    <target name="checkstyle">
        <checkstyle config="${checkstyle.config.file}">
            <fileset dir="${basedir}/src" includes="**/*.java"/>
            <classpath>
                <path refid="celtix.classpath"/>
            </classpath>
        </checkstyle>
    </target>

    <target name="clean">
        <delete dir="${build.classes.dir}"/>
        <delete dir="${build.src.dir}"/>
        <delete file="${codegen.timestamp.file}"/>
        <delete file="demo.log"/>
        <delete file="${wsdl.dir}/async_binding.xml"/>
    </target>

    <!-- Target to start JMS Broker for JMS samples -->
    <property name="activemq.home" location="${thirdparty.tools.dir}/activemq/3.2"/>
    <property name="derby.system.home" location="${build.var.dir}"/>
    <target name="jmsbroker.start">
        <java classname="org.activemq.spring.Main" fork="yes" dir="${activemq.home}/bin">
            <classpath>
                <path refid="celtix.classpath"/>
                <path location="${activemq.home}/lib/optional/commons-dbcp-1.2.jar"/>
                <path location="${activemq.home}/lib/optional/commons-pool-1.2.jar"/>
                <path location="${activemq.home}/lib/optional/commons-collections-2.1.jar"/>
                <path location="${activemq.home}/lib/optional/derby-10.0.2.1.jar"/>
            </classpath>
            <arg value="${activemq.home}/conf/activemq.xml"/>
            <jvmarg value="-Dactivemq.home=${activemq.home}"/>
            <jvmarg value="-Dderby.system.home=${derby.system.home}"/>
            <jvmarg value="-Dderby.storage.fileSyncTransactionLog=true"/>
            <sysproperty key="log4j.configuration" value="file:///${celtix.etc.dir}/log4j.properties"/>
        </java>
    </target>
        
    <target name="build"  depends="compile" description="build demo client and server"/>

    <macrodef name="celtixrun">
	    <attribute name="logging-properties-file" default="${celtix.etc.dir}/logging.properties"/>
        <attribute name="classname"/>
        <attribute name="param1" default=""/>
        <attribute name="param2" default=""/>
        <attribute name="param3" default=""/>
        <attribute name="param4" default=""/>
        <attribute name="param5" default=""/>
        <attribute name="jvmarg1" default="-D"/>
        <attribute name="jvmarg2" default="-D"/>
        <attribute name="jvmarg3" default="-D"/>
        <attribute name="jvmarg4" default="-D"/>
        <attribute name="jvmarg5" default="-D"/>
        <sequential>
            <java classname="@{classname}" fork="yes">
                <classpath>
                    <path refid="celtix.classpath"/>
                </classpath>
                <arg value="@{param1}"/>
                <arg value="@{param2}"/>
                <arg value="@{param3}"/>
                <arg value="@{param4}"/>
                <arg value="@{param5}"/>
                <jvmarg value="@{jvmarg1}"/>
                <jvmarg value="@{jvmarg2}"/>
                <jvmarg value="@{jvmarg3}"/>
                <jvmarg value="@{jvmarg4}"/>
                <jvmarg value="@{jvmarg5}"/>
                <assertions>
                    <enable package="org.objectweb.celtix"/>
                </assertions>
                <sysproperty key="java.util.logging.config.file" value="@{logging-properties-file}"/>
                <sysproperty key="log4j.configuration" value="file:///${celtix.etc.dir}/log4j.properties"/>
            </java>
        </sequential>
    </macrodef>
        
        
    <macrodef name="wsdl2java">
        <attribute name="srcdestdir" default="${build.src.dir}"/>
        <attribute name="destdir" default="${build.classes.dir}"/>
        <attribute name="file"/>
        <attribute name="bindingfile" default=""/>
        <attribute name="dir" default="${wsdl.dir}"/>
        <attribute name="package" default="NOT_SPECIFIED"/>           
        <sequential>
            <mkdir dir="@{destdir}"/>
            <mkdir dir="@{srcdestdir}"/>
            <condition property="package.arg.@{file}" value="-p @{package}">
                <not>
                    <equals arg1="@{package}" arg2="NOT_SPECIFIED"/>
                </not>
            </condition>
            <property name="package.arg.@{file}" value=""/>
            <condition property="binding.arg" value="-b @{bindingfile}">
                <not>
                    <equals arg1="@{bindingfile}" arg2=""/>
                </not>
            </condition>
            <property name="binding.arg" value=""/>
            <java failonerror="true" classname="org.objectweb.celtix.tools.Wsdl2Java" fork="yes">
                <classpath>
                    <path refid="celtix.classpath" />
                </classpath>
                <sysproperty key="java.util.logging.config.file" value="${celtix.etc.dir}/logging.properties"/>
                <sysproperty key="jaxws.home" value="${jaxws.home}"/>
                <arg line="${package.arg.@{file}}"/>
                <arg value="-keep"/>
				<arg line="${binding.arg}"/>
                <arg value="-s"/>
                <arg value="@{srcdestdir}"/>
                <arg value="-d"/>
                <arg value="@{destdir}"/>
                <arg value="@{dir}/@{file}"/>
            </java>  
        </sequential>
    </macrodef>

    <macrodef name="celtixwar">
        <attribute name="filename"/>
        <attribute name="wsdl"/>
        <attribute name="dir" default="${war.dir}"/>
        <attribute name="classesdir" default="${build.classes.dir}"/>
        <sequential>
            <mkdir dir="@{dir}"/>
            <mkdir dir="@{dir}/wartmp"/>
            <!-- This is temporary.  Until we get a classloader built into the servlet to -->
            <!-- find the jars that are needed, we need to put all the jars into the war -->
            <copy todir="@{dir}/wartmp" flatten="true">
                <fileset dir="${celtix.jar.lib.dir}">
                    <include name="*.jar"/>
                </fileset>
                <fileset dir="${thirdparty.tools.dir}">
	                <include name="spring/**/*.jar"/>
    	            <include name="wsdl4j/**/*.jar"/>
        	        <include name="jaxws-ri/**/*.jar"/>
            	    <exclude name="jaxws-ri/**/jaxws-rt.jar"/>
                	<exclude name="jaxws-ri/**/jaxws-tools.jar"/>
	            </fileset>
            </copy>
            <war destfile="@{dir}/@{filename}" webxml="${celtix.home}/etc/web.xml">
            	<classes dir="@{classesdir}"/>
                <webinf dir="${wsdl.dir}">
                    <include name="celtix-servlet.xml"/>
                </webinf>
                <webinf dir="${wsdl.dir}/..">
                    <include name="wsdl/@{wsdl}"/>
                </webinf>
                <lib dir="${celtix.jar.lib.dir}">
                    <include name="*.jar"/>
                </lib>
                <lib dir="@{dir}/wartmp">
                    <include name="*.jar"/>
                </lib>
            </war>
			<delete dir="@{dir}/wartmp" quiet="true"/>
        </sequential>
    </macrodef>
    
</project>
