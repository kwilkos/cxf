<?xml version="1.0"?>
<project name="celtix-codegenerate" basedir="../..">
    <!-- Targets for compiling the codebase -->

    <macrodef name="wsdltojava">
        <attribute name="srcdestdir"/>
        <attribute name="destdir"/>
        <attribute name="file"/>
        <attribute name="package" default="NOT_SPECIFIED"/>
        <sequential>
            <mkdir dir="@{destdir}"/>
            <mkdir dir="@{srcdestdir}"/>
            <condition property="package.arg.@{file}" value="-p @{package}">
                <not>
                    <equals arg1="@{package}" arg2="NOT_SPECIFIED"/>
                </not>
            </condition>
            <property name="package.arg.@{file}" value=""/>
            <java failonerror="true" classname="com.sun.tools.ws.WsImport" fork="true" newenvironment="true">
                <classpath>
                    <fileset dir="${jaxws.home}/lib">
                        <include name="*.jar"/>
                    </fileset>
		    <path refid="jdk.tools.classpath"/>
                </classpath>
                <arg line="${package.arg.@{file}}"/>
                <arg value="-keep"/>
                <arg value="-s"/>
                <arg value="@{srcdestdir}"/>
                <arg value="-d"/>
                <arg value="@{destdir}"/>
                <arg value="@{file}"/>
            </java>
        </sequential>
    </macrodef>

    <macrodef name="xsdtojava">
        <attribute name="destdir"/>
        <attribute name="file"/>
        <attribute name="package" default="NOT_SPECIFIED"/>
        <sequential>
            <condition property="package.arg.@{file}" value="-p @{package}">
                <not>
                    <equals arg1="@{package}" arg2="NOT_SPECIFIED"/>
                </not>
            </condition>
            <property name="package.arg.@{file}" value=""/>
            <mkdir dir="@{destdir}"/>
            <java failonerror="true" classname="com.sun.tools.xjc.Driver" fork="true" newenvironment="true">
                <classpath>
                    <fileset dir="${jaxws.home}/lib">
                        <include name="*.jar"/>
                    </fileset>
					<path refid="jdk.tools.classpath"/>
              	</classpath>
                <arg line="${package.arg.@{file}}"/>
                <arg value="-quiet"/>
                <arg value="-d"/>
                <arg value="@{destdir}"/>
                <arg value="@{file}"/>
            </java>
        </sequential>
    </macrodef>

    <target name="schemas.codegen.internal" unless="schema.codegen.notrequired">
        <xsdtojava file="${basedir}/schemas/ws-addr.xsd" destdir="${basedir}/build/src" package="org.objectweb.celtix.addressing"/>
        <xsdtojava file="${basedir}/schemas/ws-addr-wsdl.xsd" destdir="${basedir}/build/src" package="org.objectweb.celtix.addressing.wsdl"/>
        <xsdtojava file="${basedir}/schemas/wsdl.xsd" destdir="${basedir}/build/src"/>
    	<xsdtojava file="${basedir}/src/org/objectweb/celtix/configuration/types.xsd" destdir="${basedir}/build/src"/>
        <touch file="${basedir}/build/src/.SCHEMA.CODEGEN.DONE"/>
    </target>

    <target name="schemas.codegen">
        <uptodate property="schema.codegen.notrequired" value="true">
            <srcfiles dir="schemas" includes="*"/>
        	<srcfiles dir="src/org/objectweb/celtix/configuration" includes="types.xsd"/>
            <srcfiles dir="etc/ant-inc" includes="codegen.xml"/>
            <mapper type="merge" to="${basedir}/build/src/.SCHEMA.CODEGEN.DONE"/>
        </uptodate>
        <antcall target="schemas.codegen.internal"/>
    </target>

    <target name="testwsdl.codegen.internal" unless="testwsdl.codegen.notrequired">
        <wsdltojava file="${basedir}/test/wsdl/hello_world.wsdl" destdir="build/classes-tests/wsdl" srcdestdir="build/test-src"/>
        <wsdltojava file="${basedir}/test/wsdl/hello_world_rpc_lit.wsdl" destdir="build/classes-tests/wsdl" srcdestdir="build/test-src"/>
        <wsdltojava file="${basedir}/test/wsdl/handler_test.wsdl" destdir="build/classes-tests/wsdl" srcdestdir="build/test-src"/>
        <copy todir="build/classes-tests/wsdl">
            <fileset dir="${basedir}/test/wsdl" includes="**/*.wsdl"/>
        </copy>
        <touch file="${basedir}/build/test-src/.TESTWSDL.CODEGEN.DONE"/>
    </target>

    <target name="testwsdl.codegen">
        <uptodate property="testwsdl.codegen.notrequired" value="true">
            <srcfiles dir="test/wsdl" includes="*"/>
            <srcfiles dir="etc/ant-inc" includes="codegen.xml"/>
            <mapper type="merge" to="${basedir}/build/test-src/.TESTWSDL.CODEGEN.DONE"/>
        </uptodate>
        <antcall target="testwsdl.codegen.internal"/>
    </target>

    <target name="codegen" depends="schemas.codegen,testwsdl.codegen" description="Generate all generated code"/>
</project>
